#!/bin/bash
#
# Pre-commit hook para edugo-shared
# Valida formato, lint, y tests antes de commit
#

set -e

echo "๐ Ejecutando pre-commit checks..."
echo ""

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Funciรณn para mostrar error y salir
fail() {
  echo -e "${RED}โ $1${NC}"
  exit 1
}

# Funciรณn para mostrar รฉxito
success() {
  echo -e "${GREEN}โ $1${NC}"
}

# Funciรณn para mostrar warning
warn() {
  echo -e "${YELLOW}โ๏ธ  $1${NC}"
}

# 1. Verificar que hay archivos Go modificados
GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -z "$GO_FILES" ]; then
  echo "โน๏ธ  No hay archivos Go modificados, saltando checks"
  exit 0
fi

echo "๐ Archivos Go a commitear:"
echo "$GO_FILES" | sed 's/^/  - /'
echo ""

# 2. Check: go fmt
echo "๐จ Verificando formato (gofmt)..."
UNFORMATTED=$(echo "$GO_FILES" | xargs gofmt -l)
if [ -n "$UNFORMATTED" ]; then
  fail "Archivos sin formatear:\n$UNFORMATTED\n\nEjecuta: gofmt -w $UNFORMATTED"
fi
success "Formato correcto"
echo ""

# 3. Check: go vet
echo "๐ Ejecutando go vet..."
MODULES=$(echo "$GO_FILES" | xargs -n1 dirname | sort -u | grep -v "^\.github" || true)
for dir in $MODULES; do
  if [ -f "$dir/go.mod" ] || [ -f "$(dirname $dir)/go.mod" ]; then
    (cd "$dir" && go vet ./... 2>&1) || fail "go vet fallรณ en $dir"
  fi
done
success "go vet pasรณ"
echo ""

# Ruta del repo (para reusar configuraciones)
REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || pwd)

# 4. Check: golangci-lint (si estรก disponible)
if command -v golangci-lint &> /dev/null; then
  echo "๐ Ejecutando golangci-lint..."

  for dir in $MODULES; do
    if [ -f "$dir/go.mod" ]; then
      echo "  Linting $dir..."
      (cd "$dir" && golangci-lint run --timeout=2m --config="$REPO_ROOT/.golangci.yml" 2>&1) || \
        warn "Lint issues en $dir (no bloqueante)"
    fi
  done

  success "Lint completado"
  echo ""
else
  warn "golangci-lint no instalado, saltando"
  echo ""
fi

# 5. Check: Tests rรกpidos en mรณdulos modificados
echo "๐งช Ejecutando tests en mรณdulos modificados..."
TESTED_MODULES=()

for file in $GO_FILES; do
  # Determinar mรณdulo del archivo
  dir=$(dirname "$file")

  # Buscar go.mod mรกs cercano
  while [ "$dir" != "." ]; do
    if [ -f "$dir/go.mod" ]; then
      # Evitar probar mismo mรณdulo mรบltiples veces
      if [[ ! " ${TESTED_MODULES[@]} " =~ " ${dir} " ]]; then
        TESTED_MODULES+=("$dir")
        echo "  Testing $dir..."
        (cd "$dir" && go test -short -timeout=30s ./... 2>&1) || \
          fail "Tests fallaron en $dir"
      fi
      break
    fi
    dir=$(dirname "$dir")
  done
done

if [ ${#TESTED_MODULES[@]} -eq 0 ]; then
  warn "No se encontraron mรณdulos para probar"
else
  success "Tests pasaron en ${#TESTED_MODULES[@]} mรณdulo(s)"
fi
echo ""

# 6. Check: Verificar que no se commitea sensitive data
echo "๐ Verificando sensitive data..."
SENSITIVE_PATTERNS=(
  "password\s*="
  "secret\s*="
  "api_key\s*="
  "private_key"
  "BEGIN RSA PRIVATE KEY"
  "BEGIN PRIVATE KEY"
)

for pattern in "${SENSITIVE_PATTERNS[@]}"; do
  MATCHES=$(echo "$GO_FILES" | xargs grep -l -i -E "$pattern" || true)
  if [ -n "$MATCHES" ]; then
    fail "Posible sensitive data encontrada:\n$MATCHES\nPatrรณn: $pattern"
  fi
done
success "No se detectรณ sensitive data"
echo ""

# 7. Check: Verificar tamaรฑo de archivos
echo "๐ Verificando tamaรฑo de archivos..."
MAX_SIZE=$((1024 * 1024))  # 1MB
for file in $GO_FILES; do
  if [ -f "$file" ]; then
    SIZE=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo 0)
    if [ "$SIZE" -gt "$MAX_SIZE" ]; then
      warn "Archivo grande: $file ($(($SIZE / 1024))KB)"
    fi
  fi
done
success "Tamaรฑos verificados"
echo ""

# Final
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
success "Todos los checks pasaron"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

exit 0
