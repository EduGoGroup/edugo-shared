name: CI Pipeline

# Se ejecuta en PRs (flujo ideal) y push a main (red de seguridad)
on:
  pull_request:
    branches: [main, dev]
  push:
    branches: [main] # Red de seguridad por si alguien hace push directo

env:
  GO_VERSION: "1.25"

jobs:
  test-modules:
    name: Test ${{ matrix.module }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        module:
          - common
          - logger
          - auth
          - middleware/gin
          - messaging/rabbit
          - database/postgres
          - database/mongodb

    steps:
      - name: Checkout código
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: ${{ matrix.module }}/go.sum

      - name: Verificar formato
        working-directory: ${{ matrix.module }}
        run: |
          if ! gofmt -l . | grep -q .; then
            echo "✓ Código formateado correctamente"
          else
            echo "✗ Código no está formateado:"
            gofmt -l .
            exit 1
          fi

      - name: Descargar dependencias
        working-directory: ${{ matrix.module }}
        run: go mod download

      - name: Análisis estático (go vet)
        working-directory: ${{ matrix.module }}
        run: go vet ./...

      - name: Ejecutar tests con race detection
        working-directory: ${{ matrix.module }}
        run: go test -v -race ./...

      - name: Verificar build
        working-directory: ${{ matrix.module }}
        run: go build -v ./...

  # =====================================================
  # MEJORADO: Job lint aplicando lecciones de SPRINT-4
  #
  # NO MIGRADO a workflow reusable porque:
  # - edugo-shared es un MONOREPO con 7 módulos
  # - Workflow reusable está diseñado para módulo único
  # - GitHub Actions NO soporta bien strategy.matrix con uses
  #
  # MEJORAS APLICADAS:
  # - golangci-lint-action@v7 (compatible con golangci-lint v2.x)
  # - golangci-lint v2.4.0 (compilado con Go 1.25)
  # - Mantiene estructura de matriz para monorepo
  # =====================================================
  lint:
    name: Lint ${{ matrix.module }}
    runs-on: ubuntu-latest
    continue-on-error: true # No falla el CI si el linter tiene warnings
    strategy:
      fail-fast: false
      matrix:
        module:
          - common
          - logger
          - auth
          - middleware/gin
          - messaging/rabbit
          - database/postgres
          - database/mongodb

    steps:
      - name: Checkout código
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: ${{ matrix.module }}/go.sum

      - name: Descargar dependencias
        working-directory: ${{ matrix.module }}
        run: go mod download

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.4.0
          working-directory: ${{ matrix.module }}
          args: --timeout=5m
