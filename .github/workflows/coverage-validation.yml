name: Coverage Validation

on:
  push:
    branches: [dev, main]
    paths:
      - "**/*.go"
      - "go.mod"
      - "go.sum"
      - ".coverage-thresholds.yml"
      - "scripts/validate-coverage.sh"

  pull_request:
    branches: [dev, main]
    paths:
      - "**/*.go"
      - "go.mod"
      - "go.sum"
      - ".coverage-thresholds.yml"
      - "scripts/validate-coverage.sh"

  workflow_dispatch:

jobs:
  validate-coverage:
    name: Validar Umbrales de Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25"
          cache: false # Monorepo: cada m√≥dulo tiene su propio go.sum

      - name: Configurar acceso a repos privados
        run: |
          git config --global url."https://${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
        env:
          GOPRIVATE: github.com/EduGoGroup/*

      - name: Instalar bc (para comparaciones)
        run: sudo apt-get update && sudo apt-get install -y bc

      - name: Ejecutar validaci√≥n de umbrales
        id: validate
        run: |
          chmod +x scripts/validate-coverage.sh
          ./scripts/validate-coverage.sh
        continue-on-error: true

      - name: Generar reporte detallado
        if: always()
        run: |
          echo "## üìä Reporte de Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ./scripts/analyze-coverage.sh

          # Extraer resumen del reporte
          cat docs/cicd/coverage-analysis/coverage-report-*.md | head -20 >> $GITHUB_STEP_SUMMARY

      - name: Comentar en PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const dir = 'docs/cicd/coverage-analysis/';

            // Guard: si el directorio no existe o no tiene reportes, comentar sin detalle
            if (!fs.existsSync(dir)) {
              const comment = `## Validacion de Coverage\n\nNo se genero reporte de coverage. Revisar logs del pipeline.`;
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              return;
            }

            // Leer ultimo reporte
            const files = fs.readdirSync(dir);
            const latestReport = files
              .filter(f => f.startsWith('coverage-report-'))
              .sort()
              .reverse()[0];

            if (!latestReport) {
              const comment = `## Validacion de Coverage\n\nNo se encontraron reportes de coverage.`;
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              return;
            }

            const reportPath = `${dir}${latestReport}`;
            const report = fs.readFileSync(reportPath, 'utf8');

            // Extraer tabla de resumen
            const summaryMatch = report.match(/##[^#]+Resumen Ejecutivo[\s\S]*?\n\n([\s\S]*?)\n\n/);
            const summary = summaryMatch ? summaryMatch[1] : 'No disponible';

            const failedStatus = process.env.VALIDATION_FAILED === 'true';
            const action = failedStatus ? 'Algunos modulos no cumplen con los umbrales' : 'Todos los modulos cumplen';

            const comment = `## Validacion de Coverage\n\n${summary}\n\n<details>\n<summary>Ver configuracion de umbrales</summary>\n\nUmbrales definidos en .coverage-thresholds.yml\n\n</details>\n\n**Accion requerida:** ${action}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
        env:
          VALIDATION_FAILED: ${{ steps.validate.outcome == 'failure' }}

      - name: Verificar resultado
        if: steps.validate.outcome == 'failure'
        run: |
          echo "‚ùå Algunos m√≥dulos no cumplen con los umbrales de coverage"
          echo "Ver detalles arriba para m√≥dulos espec√≠ficos"
          echo ""
          echo "Opciones:"
          echo "1. Mejorar coverage de los m√≥dulos que fallan"
          echo "2. Ajustar umbrales en .coverage-thresholds.yml (justificar en PR)"
          exit 1
