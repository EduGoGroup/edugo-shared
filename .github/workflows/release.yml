name: Release CI/CD

# Solo se ejecuta cuando creas un tag de versiÃ³n
on:
  push:
    tags:
      - 'v*'  # v1.0.0, v2.0.0, etc.

env:
  GO_VERSION: '1.23'

jobs:
  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Descargar dependencias
        run: go mod download

      - name: Verificar formato
        run: |
          if ! gofmt -l . | grep -q .; then
            echo "âœ“ CÃ³digo formateado correctamente"
          else
            echo "âœ— CÃ³digo no estÃ¡ formateado:"
            gofmt -l .
            exit 1
          fi

      - name: AnÃ¡lisis estÃ¡tico (go vet)
        run: go vet ./...

      - name: Ejecutar tests
        run: go test -v -race ./...

      - name: Tests con cobertura
        run: |
          mkdir -p coverage
          # Solo ejecutar cobertura en paquetes con tests
          go test -v -race -coverprofile=coverage/coverage.out -covermode=atomic ./pkg/auth/...
          if [ -f coverage/coverage.out ]; then
            go tool cover -func=coverage/coverage.out
          fi

      - name: Verificar build
        run: go build -v ./...

      - name: Subir cobertura
        uses: codecov/codecov-action@v3
        if: success()
        with:
          file: ./coverage/coverage.out
          flags: unittests
          name: codecov-release
          fail_ci_if_error: false

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-release]
    permissions:
      contents: write

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Obtener tag actual
        id: tag
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT

      - name: Extraer changelog para esta versiÃ³n
        id: changelog
        run: |
          TAG=${{ steps.tag.outputs.tag }}

          # Extraer secciÃ³n del CHANGELOG para esta versiÃ³n
          if grep -q "## \[${{ steps.tag.outputs.version }}\]" CHANGELOG.md; then
            CHANGELOG=$(sed -n "/## \[${{ steps.tag.outputs.version }}\]/,/## \[/p" CHANGELOG.md | sed '$d')
          else
            CHANGELOG="Release $TAG"
          fi

          # Guardar a archivo para evitar problemas con caracteres especiales
          echo "$CHANGELOG" > /tmp/changelog.md

      - name: Crear GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG=${{ steps.tag.outputs.tag }}

          # Crear release con gh CLI
          gh release create "$TAG" \
            --title "Release $TAG" \
            --notes-file /tmp/changelog.md \
            --notes-start-tag "---" \
            --notes "

          ---

          ## ðŸ“¦ Installation

          ### Core Module
          \`\`\`bash
          go get github.com/EduGoGroup/edugo-shared@$TAG
          \`\`\`

          ### Database Modules
          \`\`\`bash
          # PostgreSQL
          go get github.com/EduGoGroup/edugo-shared/database/postgres@$TAG

          # MongoDB
          go get github.com/EduGoGroup/edugo-shared/database/mongodb@$TAG
          \`\`\`

          ## ðŸ“š Documentation
          - [CHANGELOG.md](https://github.com/EduGoGroup/edugo-shared/blob/$TAG/CHANGELOG.md)
          - [UPGRADE_GUIDE.md](https://github.com/EduGoGroup/edugo-shared/blob/$TAG/UPGRADE_GUIDE.md)

          ---

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)"
