name: Sync Main to Dev

# Se ejecuta despuÃ©s de push a main (generalmente despuÃ©s de release manual)
on:
  push:
    branches: [main]
    tags:
      - 'v*'

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    name: Create PR to sync main â†’ dev
    runs-on: ubuntu-latest
    # Solo ejecutar si NO es un commit de bot (evitar loops)
    if: "!contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, 'chore: sync')"

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Obtener tag/versiÃ³n actual
        id: version
        run: |
          # Obtener el tag mÃ¡s reciente
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "unknown")
          echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ VersiÃ³n actual: $LATEST_TAG"

      - name: Verificar si dev existe
        id: check_dev
        run: |
          if git ls-remote --heads origin dev | grep -q dev; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ“ Rama dev existe"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  Rama dev no existe, se crearÃ¡"
          fi

      - name: Crear rama dev si no existe
        if: steps.check_dev.outputs.exists == 'false'
        run: |
          git checkout -b dev
          git push -u origin dev
          echo "âœ“ Rama dev creada"

      - name: Verificar si hay diferencias
        id: check_diff
        run: |
          git fetch origin dev
          if git diff --quiet origin/main origin/dev; then
            echo "has_diff=false" >> $GITHUB_OUTPUT
            echo "âœ“ main y dev estÃ¡n sincronizados"
          else
            echo "has_diff=true" >> $GITHUB_OUTPUT
            echo "âš ï¸  Hay diferencias entre main y dev"
          fi

      - name: Crear PR de sync
        if: steps.check_diff.outputs.has_diff == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Crear body del PR
          BODY="## ðŸ”„ SincronizaciÃ³n AutomÃ¡tica"
          BODY="$BODY\n\nEste PR sincroniza los cambios de \`main\` ($VERSION) a \`dev\`."
          BODY="$BODY\n\n### Cambios incluidos:"
          BODY="$BODY\n- Tag de versiÃ³n: $VERSION"
          BODY="$BODY\n- CHANGELOG actualizado"
          BODY="$BODY\n- GitHub Release publicado"
          BODY="$BODY\n\n### âš ï¸ Importante:"
          BODY="$BODY\n- Si hay conflictos, resuÃ©lvelos manualmente"
          BODY="$BODY\n- Verifica que todos los mÃ³dulos estÃ©n actualizados"
          BODY="$BODY\n\n---"
          BODY="$BODY\n\nðŸ¤– PR automÃ¡tico generado por workflow \`sync-main-to-dev.yml\`"

          gh pr create \
            --base dev \
            --head main \
            --title "chore: sync main $VERSION to dev" \
            --body "$BODY" \
            --label "sync" \
            --label "automated" || echo "âš ï¸  PR ya existe o hubo un error"

      - name: Auto-merge si es posible
        if: steps.check_diff.outputs.has_diff == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Obtener nÃºmero del PR reciÃ©n creado
          PR_NUMBER=$(gh pr list --base dev --head main --json number --jq '.[0].number')

          if [ -n "$PR_NUMBER" ]; then
            echo "ðŸ“‹ PR #$PR_NUMBER creado"

            # Intentar auto-merge si no hay conflictos
            # (esto fallarÃ¡ si hay conflictos o si require approvals)
            gh pr merge "$PR_NUMBER" --auto --squash || echo "âš ï¸  Auto-merge no disponible (puede requerir aprobaciÃ³n manual)"
          fi

      - name: Resumen
        run: |
          echo "# ðŸ”„ SincronizaciÃ³n Main â†’ Dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Aspecto | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| VersiÃ³n | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Rama dev existe | ${{ steps.check_dev.outputs.exists }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Diferencias | ${{ steps.check_diff.outputs.has_diff }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_diff.outputs.has_diff }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… PR de sincronizaciÃ³n creado" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ‘‰ Revisa PRs abiertos para confirmar merge" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… main y dev ya estÃ¡n sincronizados" >> $GITHUB_STEP_SUMMARY
          fi
