name: Tests with Coverage

# Manual o en PRs
on:
  workflow_dispatch:  # Manual desde GitHub UI
  pull_request:
    branches: [ main, develop ]

jobs:
  test-coverage:
    name: Tests with Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c贸digo
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Descargar dependencias
        run: go mod download

      - name: Ejecutar tests con cobertura
        run: |
          mkdir -p coverage

          # Tests en m贸dulo principal
          go test -v -race -coverprofile=coverage/core.out -covermode=atomic ./pkg/...

          # Tests en m贸dulo PostgreSQL
          cd database/postgres
          go test -v -race -coverprofile=../../coverage/postgres.out -covermode=atomic ./...
          cd ../..

          # Tests en m贸dulo MongoDB
          cd database/mongodb
          go test -v -race -coverprofile=../../coverage/mongodb.out -covermode=atomic ./...
          cd ../..

          # Mostrar resumen
          echo ""
          echo " Resumen de Cobertura:"
          echo "======================="

          if [ -f coverage/core.out ]; then
            echo "Core module:" && go tool cover -func=coverage/core.out | tail -1
          fi

          if [ -f coverage/postgres.out ]; then
            echo "PostgreSQL module:" && go tool cover -func=coverage/postgres.out | tail -1
          fi

          if [ -f coverage/mongodb.out ]; then
            echo "MongoDB module:" && go tool cover -func=coverage/mongodb.out | tail -1
          fi

      - name: Subir reportes de cobertura
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: coverage/*.out
          retention-days: 30

      - name: Subir a Codecov
        uses: codecov/codecov-action@v3
        if: success()
        with:
          directory: ./coverage/
          flags: unittests
          fail_ci_if_error: false
